<?php
namespace Admin\Controller;

use Think\Controller;

class SubjectController extends CommonController
{
    /**
     * 科目列表
     * author: lying
     * Date: 2018/10/18
     * param where
     * return array
     */
    function index()
    {
        $map = array();
      //  $map['Status'] = 1;
        $map['ID'] = array('neq','0');
        $Name = I('Name','', 'trim');
        if($Name!=NULL && $Name!=""){
            $map['Name'] = array('like','%'.$Name.'%');
        }
        $p = $_GET['p']?$_GET['p']:1;
        $Subject = M('Subject');
        $list = $Subject->where($map)
            ->page($_GET['p'].',15')
            ->field('ID,Name,Status,Grade,CreateDate')
            ->select();
        //$this->assign('list',$list);
        $count      = $Subject->where($map)->count();
        $Page       = new \Think\Page($count,15);
        foreach($map as $key=>$val) {
            $Page->parameter[$key]   =   urlencode($val);
        }
        $count = count($list);
        for($i=0;$i<$count;$i++){
            if($list[$i]['Grade']!=null && $list[$i]['Grade']!='')
                $list[$i]['Grades'] = explode(',',$list[$i]['Grade']);

        }
        $show  = $Page->show();
        $this->assign('list',$list);// 赋值数据集
        $this->assign('page',$show);// 赋值分页输出
        $this->display(); // 输出模板
    }

    /**
     * 保存科目
     * author: lying
     * Date: 2018/11/16
     * param data array
     * return json
     */
    public function SaveSubject(){
        $time = time();
        $Subject = M("Subject");
        $ID = I('SubjectID','', 'trim');
        $returnStr['status'] = 0;
        $data['Name'] = I('Name','', 'trim');
        //$data['Grade'] = I('Grade','', 'trim');
        $data['Status'] = I('Status','', 'trim')?I('Status','', 'trim'):0;
        $data['CreateDate'] = $time;
        if(!$data['Name'])  {$returnStr['errormsg'] = '参数丢失：考试标题为空';$this->error($returnStr['errormsg']);}
      //  $data['Grade'] = json_encode( $data['Grade']);
        if($ID!=null && $ID >0){
            if ($this->HaveSubject($ID)) {
                $result = $Subject->where(array('ID' => $ID))->save($data);
                if (false !== $result || 0 !== $result) {
                    //$returnStr['status'] = 1;
                    $returnStr['errormsg'] = '修改成功';
                    $this->success($returnStr['errormsg']);
                } else {
                    $returnStr['errormsg'] = '修改失败!';
                    $this->error($returnStr['errormsg']);
                }
            }else{
                $returnStr['errormsg'] = '非法考试或者考试不存在!';
                //  $this->ajaxReturn($returnStr);
                $this->error($returnStr['errormsg']);
            }

        }
        else{
            $result = $Subject->add($data);

            if ($result){
                $returnStr['status'] = 1;
                $returnStr['errormsg'] = '提交成功';
                //$this->ajaxReturn($returnStr);
                $this->success($returnStr['errormsg']);
            }else{
                $returnStr['errormsg'] = '提交失败!';
                // $this->ajaxReturn($returnStr);
                $this->error($returnStr['errormsg']);
            }
        }
    }

    /**
     * 检查科目ID是否存在
     * author: lying
     * Date: 2018/11/15
     * param id int
     * return bool
     */
    public function HaveSubject($ID){
        $Subject = M('Subject');
        if(!$ID) return false;
        else{
            $res = $Subject->where('ID='.$ID)->find();
            if(!$res['ID']) return false;
            else return $res;
        }
    }

    /**
     * 修改考试
     * author: lying
     * Date: 2018/10/15
     * param id int
     * return json
     */
    function EditSubject()
    {
        $ID = I('SubjectID','', 'trim');
        if(!$this->HaveSubject($ID)) {
            $this->display();
        }
        else {
            $Subject = M('Subject');
            $res = $Subject->where('id='.$ID)->find();
            $res['Grade'] = json_decode($res['Grade']);
            $Grade = array();
            $dx = array("零","一","二","三","四","五","六","七","八","九","十","十一","十二");
            for($i=1;$i<=12;$i++){
                $Grade[$i]['Grade'] = $dx[$i];
                if(in_array($i,$res['Grade'])){
                    $Grade[$i]['checked'] = 1;
                }
            }

            $this->assign('data',$res);
            $this->assign('Grade',$Grade);
            $this->display();
        }
    }

    /**
     * 删除科目
     * author: lying
     * Date: 2018/11/15
     * param id int
     * return json
     */
    public function DelSubject(){
        $returnStr['Status'] = 0;
        $ID = implode(",",I('ID','','trim'));
        $Subject = M('Subject');
        if(!$ID) {
            $returnStr['errormsg'] = '非法科目或者科目不存在!';
            $this->ajaxReturn($returnStr);
        }
        else{
            $res = $Subject->where('id in ('.$ID.')')->delete();
            if ($res) {
                $returnStr['Status'] = 1;
                $returnStr['errormsg'] = '删除成功!';
                $this->ajaxReturn($returnStr);
            }
            else {
                $returnStr['errormsg'] = '删除失败!';
                $this->ajaxReturn($returnStr);
            }
        }
    }

    /**
     * 设置知识点
     * author: lying
     * Date: 2018/11/16
     * param id int
     * return json
     */

    function Knowledge(){
        $ID = I('get.SubjectID');
        $GradeID = I('get.GradeID');
        $map = array();
        $map['ID'] = array('neq','0');
        $Name = I('Name','', 'trim');
        if($Name!=NULL && $Name!=""){
            $map['Name'] = array('like','%'.$Name.'%');
        }
        if(!$ID)  {$returnStr['errormsg'] = '参数丢失：科目ID为空';$this->error($returnStr['errormsg']);}
        if(!$GradeID)  {$returnStr['errormsg'] = '参数丢失：等级ID为空';$this->error($returnStr['errormsg']);}
        if($ID!=NULL && $ID!=""){
            $map['SubjectID'] = array('eq',$ID);
        }
        if($GradeID!=NULL && $GradeID!=""){
            $map['GradeID'] = array('eq',$GradeID);
        }
        $p = $_GET['p']?$_GET['p']:1;
        $knowledge = M('knowledge');
        $list = $knowledge->where($map)
            ->page($_GET['p'].',15')
            ->field('ID,Name,SubjectID,Status,CreateDate')
            ->select();
        $count      = $knowledge->where($map)->count();
        $Page       = new \Think\Page($count,15);
        foreach($map as $key=>$val) {
            $Page->parameter[$key]   =   urlencode($val);
        }

        $show  = $Page->show();
        $this->assign('list',$list);
        $this->assign('SubjectID',$ID);
        $this->assign('GradeID',$GradeID);
        $this->assign('page',$show);
        $this->display();
    }

    /**
     * 保存知识点
     * author: lying
     * Date: 2018/11/16
     * param data array
     * return json
     */
    public function SaveKnowledge(){
        $time = time();
        $Knowledge = M("Knowledge");
        $ID = I('KnowledgeID','', 'trim');
        $returnStr['status'] = 0;
        $data['Name'] = I('Name','', 'trim');
        $data['SubjectID'] = I('SubjectID','', 'trim');
        $data['GradeID'] = I('GradeID','', 'trim');
        $data['Status'] = I('Status','', 'trim')?I('Status','', 'trim'):0;
        $data['CreateDate'] = $time;
        $where_know = "SubjectID=".$data['SubjectID']." and Name='".$data['Name']."' and GradeID=".$data['GradeID'];
        if(!$data['Name'])  {$returnStr['errormsg'] = '参数丢失：考试标题为空';$this->error($returnStr['errormsg']);}
        if(!$data['SubjectID'])  {$returnStr['errormsg'] = '参数丢失：科目ID为空';$this->error($returnStr['errormsg']);}
        if($this->HaveKnowledge($where_know))  {$returnStr['errormsg'] = '知识点已存在！';$this->error($returnStr['errormsg']);}
        if(!$this->HaveSubject($data['SubjectID']))  {$returnStr['errormsg'] = '科目不存在！';$this->error($returnStr['errormsg']);}
        if($ID!=null && $ID >0){
            if ($this->HaveKnowledge('ID='.$ID)) {
                $result = $Knowledge->where(array('ID' => $ID))->save($data);
                if (false !== $result || 0 !== $result) {
                    $returnStr['errormsg'] = '修改成功';
                    $returnStr['SubjectID'] = $data['SubjectID'];
                    $this->success($returnStr['errormsg']);
                } else {
                    $returnStr['errormsg'] = '修改失败!';
                    $this->error($returnStr['errormsg']);
                }
            }else{
                $returnStr['errormsg'] = '非法知识点或者知识点不存在!';
                $this->error($returnStr['errormsg']);
            }

        }
        else{
            $result = $Knowledge->add($data);

            if ($result){
                $returnStr['status'] = 1;
                $returnStr['errormsg'] = '提交成功';
                $returnStr['SubjectID'] = $data['SubjectID'];
                $this->success($returnStr['errormsg']);
            }else{
                $returnStr['errormsg'] = '提交失败!';
                // $this->ajaxReturn($returnStr);
                $this->error($returnStr['errormsg']);
            }
        }
    }

    /**
     * 检查知识点是否存在
     * author: lying
     * Date: 2018/11/15
     * param id int
     * return bool
     */
    public function HaveKnowledge($where){
        $Knowledge = M('Knowledge');
        if(!$where) return false;
        else{
            $res = $Knowledge->where($where)->find();
            if(!$res['ID']) return false;
            else return $res;
        }
    }

    /**
     * 修改知识点
     * author: lying
     * Date: 2018/10/15
     * param id int
     * return json
     */
    function EditKnowledge()
    {
        $ID = I('KnowledgeID','', 'trim');
        $SubjectID = I('get.SubjectID');
        $GradeID = I('get.GradeID');
        if(!$this->HaveSubject($SubjectID)) {
            $this->error('科目不存在!');
        }
        else {
            if(!$ID || !$this->HaveKnowledge('ID='.$ID)){

            }
            else{
                $Knowledge = M('Knowledge');
                $res = $Knowledge->where('id=' . $ID)->find();
                $this->assign('data', $res);
            }
        }
        $this->assign('SubjectID',$SubjectID);
        $this->assign('GradeID',$GradeID);
        $this->display();
    }

    /**
     * 删除知识点
     * author: lying
     * Date: 2018/11/15
     * param id int
     * return json
     */
    public function DelKnowledge(){
        $returnStr['Status'] = 0;
        $ID = implode(",",I('ID','','trim'));
        $Knowledge = M('Knowledge');
        if(!$ID) {
            $returnStr['errormsg'] = '非法知识点或者知识点不存在!';
            $this->ajaxReturn($returnStr);
        }
        else{
            $res = $Knowledge->where('id in ('.$ID.')')->delete();
            if ($res) {
                $returnStr['Status'] = 1;
                $returnStr['errormsg'] = '删除成功!';
                $this->ajaxReturn($returnStr);
            }
            else {
                $returnStr['errormsg'] = '删除失败!';
                $this->ajaxReturn($returnStr);
            }
        }
    }

    /**
     * 上传excel文件
     * author lying
     * Date: 2018/10/15
     * param  string $file
     * return  array
     */
    function UploadExcel()
    {
        $Type = I('Type', '', 'trim');
        $KnowledgeID = I('KnowledgeID', '', 'trim');
        $GradeID = I('GradeID', '', 'trim');
        $SubjectID = I('SubjectID', '', 'trim');
        $returnStr['status'] = 0;
        header("Content-Type:text/html;charset = utf-8");
        $upload = new \Think\Upload();
        $upload->maxSize = $_FILES['excelData']['size'];
        $upload->exts = array('xls', 'xlsx');
        $upload->rootPath = 'Public/Upload/KnowLedge/';
        $info = $upload->uploadOne($_FILES['excelData']);
        $filepath = $upload->rootPath . $info['savepath'] . $info['savename'];
        $exts = $info['ext'];
        if (!$info) {
            $this->error($upload->getError());
        } else {
            if (in_array($Type, array(1, 2, 3, 4))) {
                $data['Path'] = $upload->rootPath . $info['savepath'] . $info['savename'];
                $data['Tip'] = '题目上传';
                $data['CreateDate'] = time();
                $Uploadfile = M('Uploadfile');
                $result = $Uploadfile->add($data);
                if ($result !== false) {
                    //  $this->success('上传成功！');
                    //导出excel数据
                    $arr = $this->ReadExcel($filepath,$Type,$KnowledgeID,$GradeID,$SubjectID);

                    //导入数据库
                    $res = $this->Arr2ImportQuestions($arr);
                    if ($res['sussess']) {
                        $this->success('上传成功！一共：' . $res['num'] . '条记录,成功：' . $res['sussess'] . '条记录。重复：' . $res['repeat'] . '条记录');
                    } else {
                        $this->success('上传成功！一共：' . $res['num'] . '条记录,成功：' . $res['sussess'] . '条记录。重复：' . $res['repeat'] . '条记录');
                    }
                } else {
                    $this->error('上传失败！');
                }
            } else {
                $this->error('非法题型！');
            }
        }
    }

    /**
     * 读取excel文件
     * author lying
     * Date: 2018/10/15
     * param  string $file
     * return  array
     */
    function ReadExcel($file,$Type,$KnowledgeID,$GradeID,$SubjectID){
        header('Content-type: text/html; charset=utf-8');
        vendor('PHPExcel.PHPExcel');
        $Excel = new \PHPExcel();
        // 如果excel文件后缀名为.xls
        vendor("PHPExcel.PHPExcel.Reader.Excel5");
        // 如果excel文件后缀名为.xlsx
        // vendor("PHPExcel.PHPExcel.Reader.Excel2007");
        $PHPReader = new \PHPExcel_Reader_Excel5();
        $Excel = $PHPReader -> load($file);
        $currentSheet = $Excel -> getSheet(0);
        $allColumn = $currentSheet -> getHighestColumn();
        $allRow = $currentSheet -> getHighestRow();
        for($currentRow = 2,$i=1; $currentRow <= $allRow; $currentRow++,$i++) {
            for($currentColumn = 'A'; $currentColumn <= $allColumn; $currentColumn++) {
                $address = $currentColumn.$currentRow;
                $arr[$i][$currentColumn] = $currentSheet
                    -> getCell($address)
                    -> getValue();
            }
            $arr[$i]['Type'] = $Type;
            $arr[$i]['KnowledgeID'] = $KnowledgeID;
            $arr[$i]['GradeID'] = $GradeID;
            $arr[$i]['SubjectID'] = $SubjectID;
        }

        return $arr;
    }

    /**
     * 二维数组存入试题数据
     * author: lying
     * Date: 2018/10/16
     * param arr array
     * return bool
     */
    function Arr2ImportQuestions($arr){
        $count = count($arr);
        $Knowledge_qs = M('Knowledge_qs');
        $returnStr = array();
        $i=1;
        $returnStr['sussess']=0;
        $returnStr['repeat'] = 0;

        for(;$i<=$count;$i++) {
            $data['Type'] = $arr[$i]['Type'];
            $data['KnowledgeID'] = $arr[$i]['KnowledgeID'];
            $data['GradeID'] = $arr[$i]['GradeID'];
            $data['SubjectID'] = $arr[$i]['SubjectID'];
            $data['Title'] = $arr[$i]['A'];
            $arr1 = array();
            if($arr[$i]['Type']==3){
                $arr1[] = $arr[$i]['B'];
                $arr1[] = $arr[$i]['C'];
                $data['Answer'] = $arr[$i]['D'];
                $data['Analysis'] = $arr[$i]['E'];
                $data['Degree'] = $arr[$i]['F'];
            }elseif($arr[$i]['Type']==4){
                $arr1[] = $arr[$i]['B'];
                $data['Answer'] = $arr[$i]['C'];
                $data['Analysis'] = $arr[$i]['D'];
                $data['Degree'] = $arr[$i]['E'];
            }
            elseif($arr[$i]['Type']==2){
                $arr1[] = $arr[$i]['B'];
                $arr1[] = $arr[$i]['C'];
                $arr1[] = $arr[$i]['D'];
                $arr1[] = $arr[$i]['E'];
                $arr1[] = $arr[$i]['F'];
                $data['Answer'] = $arr[$i]['G'];
                $data['Analysis'] = $arr[$i]['H'];
                $data['Degree'] = $arr[$i]['I'];
            }else{
                $arr1[] = $arr[$i]['B'];
                $arr1[] = $arr[$i]['C'];
                $arr1[] = $arr[$i]['D'];
                $arr1[] = $arr[$i]['E'];
                $data['Answer'] = $arr[$i]['F'];
                $data['Analysis'] = $arr[$i]['G'];
                $data['Degree'] = $arr[$i]['H'];
            }
            $data['Options'] = json_encode($arr1);
            $data['Status'] = 1;
            $data['Mode'] = 0;
            $data['CreateDate'] = time();
            $where = array(
                'Type'=> $data['Type'],
                'Title'=> $data['Title'],
                'Options'=> $data['Options'],
                'Answer'=> $data['Answer'],
                'Analysis'=> $data['Analysis'],
                'Degree'=> $data['Degree']
                // 'Mode'=> 0
            );

            if(!$this->HaveQuestions($where)) {
                $res = $Knowledge_qs->add($data);
                if ($res)
                    $returnStr['sussess'] = $returnStr['sussess'] + 1;
            }else{
                $returnStr['repeat'] = $returnStr['repeat']+1;
            }

        }
        $returnStr['num'] = $count;
        return $returnStr;
    }

    /**
     * 检查试题是否存在
     * author: lying
     * Date: 2018/10/15
     * param data array
     * return bool
     */
    function HaveQuestions($where)
    {
        $Knowledge_qs = M('Knowledge_qs');
        if (!$where) return false;
        else {
            $res = $Knowledge_qs->where($where)->find();

            if (!$res) return false;
            else return true;
        }
    }

    /**
     * 设置知识点
     * author: lying
     * Date: 2018/11/16
     * param id int
     * return json
     */

    function Knowledgeqs(){
        $ID = I('get.KnowledgeID');
        $map = array();
        $map['ID'] = array('neq','0');
        $Name = I('Name','', 'trim');
        if($Name!=NULL && $Name!=""){
            $map['Name'] = array('like','%'.$Name.'%');
        }
        if(!$ID)  {$returnStr['errormsg'] = '参数丢失：科目ID为空';$this->error($returnStr['errormsg']);}

        if($ID!=NULL && $ID!=""){
            $map['KnowledgeID'] = array('eq',$ID);
        }

        $p = $_GET['p']?$_GET['p']:1;
        $knowledge_qs = M('knowledge_qs');
        $list = $knowledge_qs->where($map)
            ->page($_GET['p'].',15')
            ->field('ID,Title,KnowledgeID,Options,Answer,Type,Degree,Status,CreateDate')
            ->select();
        $count      = $knowledge_qs->where($map)->count();
        $Page       = new \Think\Page($count,15);
        foreach($map as $key=>$val) {
            $Page->parameter[$key]   =   urlencode($val);
        }

        $show  = $Page->show();
        $this->assign('list',$list);
        $this->assign('SubjectID',$ID);
        $this->assign('page',$show);
        $this->display();
    }

    /**
     * 修改题目
     * author: lying
     * Date: 2018/11/19
     * param id int
     * return string
     */
    function EditKnowledgeQs()
    {
        $Knowledge_qs = M('Knowledge_qs');
        $ID = I('get.ID');
        if(!$this->HaveQuestions(array('ID'=>$ID))) {
            $returnStr['errormsg'] = '非法考试或者考试不存在!';
            $this->error($returnStr['errormsg']);
        }
        else {
            $Knowledge_qs = M('Knowledge_qs');
            $res = $Knowledge_qs->where('ID='.$ID)->find();
            //拆分题目
            $res['Options'] = json_decode($res['Options'],true);
            $this->assign('data',$res);
            $this->display();
        }
    }

    /**
     * 保存题目
     * author: lying
     * Date: 2018/10/17
     * param post array
     * return string
     */
    function SaveKnowledgeqs()
    {
        $time = time();
        $Knowledgeqs = M('Knowledge_qs');
        $ID =I('ID','', 'trim');
        $data['Type'] = I('Type','', 'trim');
        $data['Title'] = I('Title','', 'trim');
        $data['Options'] = I('Options','', 'trim');
        $data['Answer'] = I('Answer','', 'trim');
        $data['Analysis'] = I('Analysis','', 'trim');
        $data['Degree'] = I('Degree','', 'trim');
        $data['Status'] = 1;
        $data['Mode'] = 0;
        $data['CreateDate'] = $time;
        if(!$data['Type'])  {$returnStr['errormsg'] = '参数丢失：题目类型为空';$this->error($returnStr['errormsg']);}
        if(!$data['Title'])  {$returnStr['errormsg'] = '参数丢失：题目名称为空！';$this->error($returnStr['errormsg']);}
        if(!$data['Options'])  {$returnStr['errormsg'] = '参数丢失：题目选项为空！';$this->error($returnStr['errormsg']);}
        if(!$data['Answer'])  {$returnStr['errormsg'] = '参数丢失：题目答案为空！';$this->error($returnStr['errormsg']);}
        if(!$data['Degree'])  {$returnStr['errormsg'] = '参数丢失：请选择难易程度！';$this->error($returnStr['errormsg']);}
        if($ID!=null && $ID >0){
            if ($this->HaveQuestions($ID)) {
                $data['Options'] = json_encode( $data['Options']);
                $result = $Knowledgeqs->where(array('ID' => $ID))->save($data);
                if (false !== $result || 0 !== $result) {
                    $returnStr['errormsg'] = '修改成功';
                    $returnStr['ID'] = $ID;
                    $this->success($returnStr['errormsg']);
                } else{
                    $returnStr['errormsg'] = '修改失败!';
                    $returnStr['ID'] = $ID;
                    $this->error($returnStr['errormsg']);
                }
            }else{
                $returnStr['errormsg'] = '非法题目或者题目不存在!';
                $this->error($returnStr['errormsg']);
            }

        }
        else{

            $where = array(
                'Type'=> $data['Type'],
                'Title'=> $data['Title'],
                'Options'=> $data['Options'],
                'Analysis'=> $data['Analysis'],
                'Degree'=> $data['Degree'],
                'Answer'=> $data['Answer']
                // 'Mode'=> 0
            );
            if(!$this->HaveQuestions($where)) {

                $result = $Knowledgeqs->add($data);
                $data['Options'] = json_encode( $data['Options']);
                if ($result){
                    $returnStr['status'] = 1;
                    $returnStr['errormsg'] = '提交成功';
                    $this->success($returnStr['errormsg']);
                }else{
                    $returnStr['errormsg'] = '提交失败!';
                    $this->error($returnStr['errormsg']);
                }
            }else{
                $returnStr['errormsg'] = '题目重复：题目已存在!';
                $this->error($returnStr['errormsg']);
            }

        }
    }

    /**
     * 删除考题
     * author: lying
     * Date: 2018/10/18
     * param id int
     * return json
     */
    public function DelQuestions(){
        $returnStr['status'] = 0;
        $QuestionsArr = implode(",",I('ID','','trim'));
        $Knowledge_qs = M('Knowledge_qs');
        if(!$QuestionsArr) return false;
        else{
            $res = $Knowledge_qs->where('ID in('.$QuestionsArr.')')->delete();
            if ($res) {
                $returnStr['status'] = 1;
                $returnStr['errormsg'] = '删除成功!';
            }
            else{
                $returnStr['errormsg'] = '删除失败!';
            }
        }
        $this->ajaxReturn($returnStr);
    }

    /**
     * 添加【保存】考题等级
     * author: lying
     * Date: 2018/11/18
     * param SubjectID int Grade int
     * return json
     */
    public function SaveGrade(){
        $returnStr['status'] = 0;
        $ID =I('SubjectID','', 'trim');
        $data = array();
        $GradeID =I('Grade','', 'Interval');
        if(!$ID)  {$returnStr['errormsg'] = '参数丢失：科目ID为空！';$this->error($returnStr['errormsg']);}
        if(!$res = $this->HaveSubject($ID)){
            $returnStr['errormsg'] = '非法科目或者科目不存在！';$this->error($returnStr['errormsg']);
        }else{
            if($res['Grade']!=null && $res['Grade']!='')
                $data['Grade'] = $res['Grade'].','.$GradeID;
            else
                $data['Grade'] = $GradeID;
            $returnStr['status'] = 1;
            $returnStr['errormsg'] = '修改成功!';
        }
        $this->ajaxReturn($returnStr);
    }

    /**
     * 删除等级
     * author: lying
     * Date: 2018/11/15
     * param GradeID SubjectID
     * return json
     */
    public function DelGrade(){
        $returnStr['Status'] = 0;
        $GradeID = I('GradeID','','trim');
        $SubjectID = I('SubjectID','','trim');
        $Subject = M('Subject');
        if(!$GradeID && !$SubjectID) {
            $returnStr['errormsg'] = '非法科目或者科目不存在!';
            $this->ajaxReturn($returnStr);
        }
        else{
            $res = $Subject
                ->field('ID,Grade')
                ->where('ID='.$SubjectID)->find();
            if ($res) {
                if(!$res['Grade']){
                    $returnStr['errormsg'] = '科目等级不存在!';
                    $this->ajaxReturn($returnStr);
                }else {
                    $Grade = explode(',',$res['Grade']);
                    if($key = in_array($GradeID,$Grade)){
                        unset($Grade[$key]);
                        array_values($Grade);
                        $returnStr['Status'] = 1;
                        $returnStr['errormsg'] = '删除成功!';
                        $this->ajaxReturn($returnStr);
                    }else{
                        $returnStr['errormsg'] = '删除失败!';
                        $this->ajaxReturn($returnStr);
                    }

                }
            }
            else {
                $returnStr['errormsg'] = '科目不存在!';
                $this->ajaxReturn($returnStr);
            }
        }
    }

}
?>