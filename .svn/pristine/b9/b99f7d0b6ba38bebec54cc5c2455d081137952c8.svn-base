<?php
namespace Mobile\Controller;

use Think\Controller;

class PracticeController extends Controller
{
    public  $zm = array("-","A","B","C","D","E","F","G","H","I");
    public  $zm1 = array("A","B","C","D","E","F","G","H","I");
    public  $sz = array("-","1","2","3","4","5","6","7","8","9");
    public $num = 20;
    /**
     * 科目列表
     * author: lying
     * Date: 2018/10/18
     * param id int session array
     * return string
     */
    public function Index()
    {
        IsLogin();
        $action = I('get.action');
        if($action == 'RandPractice')
            $this->RandPractice();
        elseif($action == 'WrongQsPractice')
            $this->WrongQsPractice();
        elseif($action == 'AllWrongQsPractice')
            $this->AllWrongQsPractice();
        elseif($action == 'KnowledgePractice')
            $this->KnowledgePractice();
        $this->assign('User',$_SESSION['User']);
        $this->display();
    }

    /**
     * 生成随机题目
     * author: lying
     * Date: 2018/10/17
     * param id int
     * return array
     */
    function RandPractice(){

        IsLogin();
        $SubjectID = I('SubjectID', '', 'trim');
        $GradeID = I('GradeID', '', 'trim');
        $KnowledgeID = I('KnowledgeID', '', 'trim');
        $Subject = M('Subject');
        $Questions = array();
        $Answers = array();
        if(!$SubjectID) $this->error('非法入口！');
        else{
            if(!$this->HaveSubjectGrade($SubjectID,$GradeID)) {
                $returnStr['errormsg'] = '非法科目或者科目不存在!';
                $this->error($returnStr['errormsg']);
            }else{
                $where = 'Type in (1,2,3) ';
                if($SubjectID!=NULL && $SubjectID!=''){
                    $where.=' and SubjectID='.$SubjectID;
                }
                if($GradeID!=NULL && $GradeID!=''){
                    $where.=' and GradeID='.$GradeID;
                }
                if($KnowledgeID!=NULL && $KnowledgeID!=''){
                    $where.=' and KnowledgeID='.$KnowledgeID;
                }

                $field = 'ID,Title,Options,Type,Answer';
                $Questions = $this->setQuestion($where, $field, $this->num,'RandPractice');
                $this->assign('title','随机练习');
                $res =  $this->Obj2Arr($Questions);
                //var_dump($res);
                $this->assign('practice',$res);
                $this->assign('num',count($Questions));
                $this->assign('SubjectID',$SubjectID);
                $this->assign('KnowledgeID',$KnowledgeID);
                $this->assign('GradeID',$GradeID);
                $this->assign('zm',$this->zm);
            }
        }
    }

    /**
     * 错题随机题目
     * author: lying
     * Date: 2018/10/17
     * param id int
     * return array
     */
    function WrongQsPractice(){
        IsLogin();
        $SubjectID = I('SubjectID', '', 'trim');
        $GradeID = I('GradeID', '', 'trim');
        $Subject = M('Subject');
        $Questions = array();
        $Answers = array();
        if(!$SubjectID) $this->error('非法入口！');
        else{
            if(!$this->HaveSubjectGrade($SubjectID,$GradeID)) {
                $returnStr['errormsg'] = '非法科目或者科目不存在!';
                $this->error($returnStr['errormsg']);
            }else{
                $field = 'ID,Title,Options,Type,Answer';
                //错题ID
                $practice_history = M('practice_history');
                $where_wrong['UserID'] = array('eq',1);
                $where_wrong['SubjectID'] = array('eq',$SubjectID);
                $where_wrong['GradeID'] = array('eq',$GradeID);
                $res = $practice_history->where($where_wrong)->limit(20)->getField("QID",true);
                $where['ID'] = array('in',implode(',',$res));
                $Questions = $this->setQuestion($where, $field, $this->num,'WrongQsPractice');
                $this->assign('title','错题练习');
                $res =  $this->Obj2Arr($Questions);
                $this->assign('practice',$res);
                $this->assign('SubjectID',$SubjectID);
                $this->assign('GradeID',$GradeID);
                $this->assign('zm',$this->zm);
            }
        }
    }

    /**
     * 所有的错题
     * author: lying
     * Date: 2018/10/17
     * param id int
     * return array
     */
    function AllWrongQsPractice(){
        $SubjectID = I('get.SubjectID');
        $GradeID = I('get.GradeID');
        IsLogin();
        $field = 'ID,Title,Options,Type,Answer';
        //错题ID
        $practice_history = M('practice_history');
        $where_wrong['UserID'] = array('eq',$_SESSION['User']['UserID']);
        $res = $practice_history->where($where_wrong)->limit(20)->getField("QID",true);
        $where['ID'] = array('in',implode(',',$res));
        $Questions = $this->setQuestion($where, $field, $this->num,'WrongQsPractice');
        $this->assign('title','我的错题');
        $res =  $this->Obj2Arr($Questions);
        $this->assign('practice',$res);
        $this->assign('zm',$this->zm);
        $this->assign('SubjectID',$SubjectID);
        $this->assign('GradeID',$GradeID);
        $this->assign('num',count($res));
    }

    /**
     * 知识点题目
     * author: lying
     * Date: 2018/10/17
     * param id int
     * return array
     */
    function KnowledgePractice(){
        IsLogin();
        // $SubjectID = I('SubjectID', '', 'trim');
        // $GradeID = I('GradeID', '', 'trim');
        $KnowledgeID = I('KnowledgeID', '', 'trim');
        $Subject = M('Subject');
        $Questions = array();
        $Answers = array();
        // if(!$SubjectID) $this->error('非法入口！');
        //else{
        //if(!$this->HaveSubjectGrade($SubjectID,$GradeID)) {
        //    $returnStr['errormsg'] = '非法科目或者科目不存在!';
        //   $this->error($returnStr['errormsg']);
        // }else{
        $where = 'Type in (1,2,3) ';
        //if($SubjectID!=NULL && $SubjectID!=''){
        //     $where.=' and SubjectID='.$SubjectID;
        // }
        //  if($GradeID!=NULL && $GradeID!=''){
        //      $where.=' and GradeID='.$GradeID;
        //  }
        if($KnowledgeID!=NULL && $KnowledgeID!=''){
            $where.=' and KnowledgeID='.$KnowledgeID;
        }
        $field = 'ID,Title,Options,Type,Answer';
        $Questions = $this->setQuestion($where, $field, $this->num,'KnowledgePractice');
        $this->assign('title','知识点练习');
        $res =  $this->Obj2Arr($Questions);
        $this->assign('practice',$res);
        $this->assign('num',count($res));
        // $this->assign('SubjectID',$SubjectID);
        // $this->assign('GradeID',$GradeID);
        $this->assign('KnowledgeID',$KnowledgeID);
        $this->assign('zm',$this->zm);
    }
    // }
    //}
    /**
     * 对象转化为二维数组
     * author: lying
     * Date: 2018/10/19
     * param object
     * return array
     */
    protected function Obj2Arr($object){
        $count = count($object);
        for($i=0;$i<$count;$i++){
            $object[$i]['Options'] = json_decode($object[$i]['Options'],true);
        }

        return $object;
    }

    /**
     * 出题目
     * author: lying
     * Date: 2018/11/17
     * param where array
     * return data array
     */
    protected function setQuestion($where,$field,$num,$type){
        $arr = array();
        //随机练习
        if($type == 'RandPractice') {
            //$where .= ' and status=1 and id >= (SELECT floor(RAND() * (SELECT MAX(id) FROM knowledge_qs where '.$where.'))) ';
            $query = 'select '.$field.' from knowledge_qs where status=1 and '.$where.' order by rand() LIMIT '.$num;
            $knowledge_qs = M('knowledge_qs');
            $arr = $knowledge_qs->query($query);
        }elseif($type == 'WrongQsPractice'){   //错题练习
            $knowledge_qs = M('knowledge_qs');
            $arr = $knowledge_qs->where($where)
                ->field($field)
                ->limit($num)
                ->select();

        }elseif($type == 'KnowledgePractice'){
            $knowledge_qs = M('knowledge_qs');
            $arr = $knowledge_qs->where($where)
                ->field($field)
                ->limit($num)
                ->select();
        }
        $count = count($arr);
        for($i=0;$i<$count;$i++){
            $arr[$i]['rigntrate'] = getRightRate(array("QID"=>$arr[$i]['ID']),'practice_history');
            $where2['UserID'] = $_SESSION['User']['UserID'];
            $where2['QID'] = $arr[$i]['ID'];
            $arr[$i]['Iscollect'] = $this->Iscollect($where2);
        }
        return $arr;
    }

    /**
     * 检查科目ID是否存在
     * author: lying
     * Date: 2018/11/15
     * param id int
     * return bool
     */
    protected function HaveSubjectGrade($ID,$GradeID)
    {
        $Subject = M('Subject');
        if (!$ID && !$GradeID) return false;
        else {
            $res = $Subject->where('ID=' . $ID)->find();
            $Grade = explode(',', $res['Grade']);
            if ($key = in_array($GradeID, $Grade)) {
                if (!$res['ID'] && $key) return false;
                else return $res;
            }
        }
    }

    /**
     * 提交试卷，得出分数
     * author: lying
     * Date: 2018/10/18
     * param string ZKZH identity string
     * return bool
     */

    function  MakeScore()
    {
        IsLogin();
        $returnStr['status'] = 0;
        $knowledge_qs = M('knowledge_qs');
        $practice_history = M('practice_history');
        $data['UserID'] = $_SESSION['User']['UserID'];
        $SubjectID = I('SubjectID', '', 'trim') ? I('SubjectID', '', 'trim') : 0;
        $GradeID = I('GradeID', '', 'trim') ? I('GradeID', '', 'trim') : 0;
        $answers = I('answers', '', 'trim') ? I('answers', '', 'trim') : 0;
        if(!$SubjectID)  {$returnStr['errormsg'] = '参数丢失：考试科目ID为空';$this->error($returnStr['errormsg']);}
        if(!$GradeID)  {$returnStr['errormsg'] = '参数丢失：考试科目级别ID为空';$this->error($returnStr['errormsg']);}
        if(!$answers)  {$returnStr['errormsg'] = '参数丢失：答案为空';$this->error($returnStr['errormsg']);}
        //var_dump($answers);
        $answersarr = json_decode($answers);
        $count = count($answersarr);
        $rightNum = 0;
        unset($_SESSION['User']['random_practice']);
        for($i=0;$i<$count;$i++){
            //答案拆分 --匹配多选单选情况
            $ID = array_pop($answersarr[$i]);
            //将答案转换为字母
            $count_op = count($answersarr[$i]);
            for($j=0;$j<$count_op;$j++){
                $op[$j] = $this->zm[$answersarr[$i][$j]];
            }
            $data['QID'] = $ID;
            $where['ID'] = array('eq',$ID);
            $data['UserID'] = $_SESSION['User']['UserID'];
            $data['GradeID'] = $GradeID;
            $data['SubjectID'] = $SubjectID;
            $data['Answer'] = implode(',',$op);
            $data['TrueAnswer'] = $knowledge_qs->where($where)->getField('Answer');
            if($data['TrueAnswer'] == $data['Answer']) {
                $data['IsTrue'] = 1;
                $rightNum = $rightNum +1;
            }
            else
                $data['IsTrue'] = 0;
            $data['CreateTime'] = time();

            $practice_history->add($data);
            $_SESSION['User']['random_practice'][$i]['QID'] = $data['QID'];
            $_SESSION['User']['random_practice'][$i]['Answer'] = $answersarr[$i];
            $_SESSION['User']['random_practice'][$i]['TrueAnswer'] = $data['TrueAnswer'];
            $_SESSION['User']['random_practice'][$i]['IsTrue'] = $data['IsTrue'];
            $data = array();
        }
        if($i == $count){
            $returnStr['status'] = 1;
            $returnStr['msg'] = '提交成功!';
        }else{
            $returnStr['msg'] = '提交失败!';
        }
        $this->ajaxReturn($returnStr);
    }

    /**
     * 提交题目，答案列表
     * author: lying
     * Date: 2018/10/18
     * param string action identity string
     * return bool
     */
    function  AnswerSheet(){
        IsLogin();
        $action = I('get.action')?I('get.action'):'';
        if(!$action)  {$this->error('参数错误!');}
        switch ($action){
            case 'RandPractice':
                $this->assign('list',$_SESSION['User']['random_practice']);
                break;
            default:
                $this->error('参数错误!');
                break;
        }
        $this->display();
    }

    /**
     * 单个题目解析
     * author: lying
     * Date: 2018/11/18
     * param string action identity string
     * return bool
     */
    function  Analysis(){
        $knowledge_qs = M('knowledge_qs');
        $action = I('get.action')?I('get.action'):'';
        $ID = I('get.ID')?I('get.ID'):'';
        $key = I('get.key')?I('get.key'):'';
        if(!$action)  {$this->error('参数错误!');}
        if(!$ID)  {$this->error('ID错误!');}
        if(!$key)  {$this->error('key错误!');}
        switch ($action){
            case 'RandPractice':
                $questions = $knowledge_qs->where('ID='.$ID)->field('Title,Options')->find();
                $questions_s = json_decode($questions['Options']);
                $count_qs = count($questions_s);
                for($i= 0;$i<$count_qs;$i++){
                    $questions['option'][$i]['val'] =$questions_s[$i];
                    $questions['option'][$i]['ischecked'] = in_array($i+1,$_SESSION['User']['random_practice'][$key-1]['Answer']);
                }
                // var_dump($_SESSION['User']['random_practice'][$key-1]);
                $this->assign('info',$_SESSION['User']['random_practice'][$key-1]);
                $this->assign('questions',$questions);
                $this->assign('zm',$this->zm);
                break;
            default:
                $this->error('参数错误!');
                break;
        }
        $this->display();
    }

    /**
     * 单个题目
     * author: lying
     * Date: 2018/11/18
     * param string action identity string
     * return bool
     */
    function  OneQ(){
        $knowledge_qs = M('knowledge_qs');
        $action = I('get.action')?I('get.action'):'';
        $ID = I('get.ID')?I('get.ID'):'';
        if(!$action)  {$this->error('参数错误!');}
        if(!$ID)  {$this->error('ID错误!');}
        $questions = $knowledge_qs->where('ID='.$ID)->field('ID,Title,Options,Answer,Type')->find();
        $questions_s = json_decode($questions['Options']);
        $count_qs = count($questions_s);
        for($i= 0;$i<$count_qs;$i++){
            $questions['option'][$i]['val'] =$questions_s[$i];
            //$questions['option'][$i]['ischecked'] = in_array($i+1,$_SESSION['User']['random_practice'][$key]['Answer']);
        }
        $where2['UserID'] = $_SESSION['User']['UserID'];
        $where2['QID'] = $questions['ID'];
        $questions['Iscollect'] = $this->Iscollect($where2);
        $this->assign('questions',$questions);
        $this->assign('zm',$this->zm);
        $this->display('Analysis');
    }

    /*是否收藏*/
    function Iscollect($where){
        IsLogin();
        $user_collect = M('user_collect');
        $res = $user_collect->where($where)->getField('ID');

        if($res){
            return 1;
        }else{
            return 0;
        }
    }
    /*
    ** 糾錯功能
    */
    function Correction(){
        IsLogin();
        $Correction = M('Correction');
        $returnStr['status'] = 0;
        $QID = I('post.QID')?I('post.QID'):0;
        $Answer = I('post.Answer')?I('post.Answer'):0;
        $Reason = I('post.Reason')?I('post.Reason'):0;
        $data['UserID'] = $_SESSION['User']['UserID'];
        if(!$QID) { $returnStr['errormsg'] = 'QID为空!';$this->ajaxReturn($returnStr);}
        if(!$Answer) { $returnStr['errormsg'] = 'Answer为空!';$this->ajaxReturn($returnStr);}
        if(!$Reason) { $returnStr['errormsg'] = 'Reason为空!';$this->ajaxReturn($returnStr);}
        else{
            $data['Status'] = 0;
            $data['QID'] = $QID;
            $data['Answer'] = $Answer;
            $data['Reason'] = $Reason;
            $data['CreateDate'] = time();
            $res = $Correction->add($data);
            if($res){
                $returnStr['status'] = 1;
                $returnStr['errormsg'] = '发送成功!';$this->ajaxReturn($returnStr);
            }else{
                $returnStr['errormsg'] = '发送失败!';$this->ajaxReturn($returnStr);
            }
        }
    }
    function ShowExam(){
        $ExamID = I('get.ExamID');
        if(!$ExamID) $this->error('ExamID为空');
        $ExaminationPager = M('OldExaminationPager');
        $res2 = $ExaminationPager->where('ExamID='.$ExamID)->order('CreateDate desc')->find();
        $Questions = json_decode($res2['Questions'],true);
        $ress = count($Questions);
        $xs = array();
        for($j=0;$j<$ress;$j++) {
            $sds = count($Questions[$j]);
            if($sds>0) {
                for ($i = 0; $i < $sds; $i++) {
                    $xs['Questions'][$j][$i]['Title'] = $Questions[$j][$i]['Title'];
                    $xs['Questions'][$j][$i]['TW'] = $Questions[$j][$i]['TW'];
                    $xs['Questions'][$j][$i]['Type'] = $Questions[$j][$i]['Type'];
                    $xs['Questions'][$j][$i]['QID'] = $Questions[$j][$i]['ID'];
                    $xs['Questions'][$j][$i]['TWPic'] = $Questions[$j][$i]['TWPic'];
                    $xs['Questions'][$j][$i]['Options'] = json_decode($Questions[$j][$i]['Options'], true);
                    // $xs['Questions'][$i]['Answer'] = $Reply[$i];
                }
            }
        }
        $this->assign('res',$xs);
        $this->assign('zm1',$this->zm1);
        $this->display();
    }
    function ExamList(){
        $map = array();
        $map['Status'] = 1;
        $Exam = M('OldExam');
        $list = $Exam->where($map)
            ->field('ID,Name,Start,End,Status,CreateDate')
            ->select();
       // $count      = $Exam->where($map)->count();
       // $Page       = new \Think\Page($count,15);

        //$show  = $Page->show();
        $this->assign('list',$list);// 赋值数据集
        $this->display(); // 输出模板
    }
    /**
     * 提交试卷，得出分数
     * author: lying
     * Date: 2018/10/18
     * param string ZKZH identity string
     * return bool
     */
    function MakeOldScore()
    {
        $returnStr['status'] = 0;
        $data['ExamID'] = I('ExamID','', 'trim')?I('ExamID','', 'trim'):1;
        if(!$this->HaveExam($data['ExamID'])) {
            // $this->error('非法考试或者考试不存在!');
            $returnStr['msg'] = '非法考试或者考试不存在！';
        }
        else {
            $Reply= I('Reply','', 'trim');
            /* $Reply = array(
                 "1",
                 "2",
                 array("1","2"),
                 array("1","2"),
                 "2",
                 "1",
             );*/
            $Reply = $this->Num2Char($Reply);
            $ExaminationPager = M('ExaminationPager');
            $where = array("ExamID" => $data['ExamID'], "Status" => 1);
            $Result = $ExaminationPager->where($where)->field('ID,Answers')->find();
            $Score = 0;
            if (!$Result) {
                // $this->error('考试出现错误，无法匹对系统答案，请联系工作人员！');
                $returnStr['msg'] = '考试出现错误，无法匹对系统答案，请联系工作人员！';
            }else {
                $Answers = json_decode($Result['Answers'],true);
                $Index = $this->getSY($data['ExamID']);
                $AnswersNum = count($Answers);
                //算分数 计算选择题分数
                for ($i=0,$OptionsScore=0,$MultipleScore=0,$JudgeScore=0;$i<$AnswersNum; $i++) {

                    if($i<$Index[0]){
                        if ($Reply[$i] == $Answers[$i]['Answer']) {
                            $OptionsScore = $OptionsScore + 1;
                        }
                    }
                    elseif($i>=$Index[0] && $i<$Index[1]){
                        //选项升序排列
                        sort($Reply[$i]);
                        //$arrs = explode(",", $Answers[$i]['Answer']);
                        $strings = implode(",",$Reply[$i]);
                        if($Answers[$i]['Answer'] == $strings)
                            $MultipleScore = $MultipleScore + 1;
                    }
                    elseif($i>=$Index[1] && $i<$Index[2]){
                        if ($Reply[$i] == $Answers[$i]['Answer']) {
                            $JudgeScore = $JudgeScore + 1;
                        }
                    }
                }
                $Score = $OptionsScore + $MultipleScore + $JudgeScore;
                $data['ExamID'] = $data['ExamID']?$data['ExamID']:1;
                $data['ExamineeID'] = $_SESSION['User']['UserID'];
                $data['Reply'] = json_encode($Reply);
                $data['CreateDate'] = time();
                if(isset($_SESSION['User']['UserID']) && $_SESSION['User']['UserID']!=NULL &&
                    isset($_SESSION['User']['Username']) && $_SESSION['User']['Username']!=NULL &&
                    isset($_SESSION['User']['ZKZH']) && $_SESSION['User']['ZKZH']!=NULL){
                    $ExamRecord = M('ExamRecord');
                    $scs = $this->HaveExaminee(array("ExamID"=>$data['ExamID'],"ID"=>$_SESSION['User']['UserID']));
                    if($this->IsExamed($data) && $scs['Score'] == 0){
                        $data['Score'] = $Score;
                        $res = $ExamRecord->add($data);
                        $Examinee = M('Examinee');
                        $res1 = $Examinee->where('ID='.$_SESSION['User']['UserID'].' and ExamID='.$data['ExamID'])->save(array("Score"=>$Score));
                        if($res && $res1){
                            $returnStr['status'] = 1;
                            $returnStr['Score'] = $Score;
                            $returnStr['msg'] = '提交试卷成功！';
                        }

                    }else{
                        $returnStr['Score'] = $scs['Score'];
                        $returnStr['msg'] = '您已经提交过，请勿重复提交试卷！';
                    }
                }
                else{
                    $returnStr['msg'] = '非法考生,请登录！';
                }
            }
        }
        $this->assign("data",$returnStr);
        $this->display();
    }
}